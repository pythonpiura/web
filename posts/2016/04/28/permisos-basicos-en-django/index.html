<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="es">
<head>
<meta charset="utf-8">
<base href="http://pythonpiura.org/posts/2016/04/28/permisos-basicos-en-django/">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aplicar Permisos por Usuario en Django | Python Piura</title>
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../../rss.xml">
<link rel="canonical" href="http://pythonpiura.org/posts/2016/04/28/permisos-basicos-en-django/">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Comunidad Python Piura">
<link rel="prev" href="../mejorando-nuestro-login/" title="Mejorando Nuestro Login" type="text/html">
<link rel="next" href="../../../05/02/personalizando-permisos/" title="Personalizando Permisos" type="text/html">
<meta property="og:site_name" content="Python Piura">
<meta property="og:title" content="Aplicar Permisos por Usuario en Django">
<meta property="og:url" content="http://pythonpiura.org/posts/2016/04/28/permisos-basicos-en-django/">
<meta property="og:description" content="Hasta ahora solo hemos trabajado con un usuario(el superusuario que creamos al principio) en nuestro proyecto, pero en la vida real son muchos los usuarios que interactuan con el software y todos no c">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-04-28T22:33:04-05:00">
<meta property="article:tag" content="Django">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://pythonpiura.org/">

                <span id="blog-title">Python Piura</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../../../blog">Blog</a>
                </li>
<li>
<a href="../../../../../eventos">Eventos</a>
                </li>
<li>
<a href="../../../../../recursos">Recursos</a>
                </li>
<li>
<a href="../../../../../contactenos">Contáctenos</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.src.html" id="sourcelink">Código fuente</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Aplicar Permisos por Usuario en Django</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Comunidad Python Piura
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-04-28T22:33:04-05:00" itemprop="datePublished" title="2016-04-28 22:33">2016-04-28 22:33</time></a></p>
            
        <p class="sourceline"><a href="index.src.html" id="sourcelink">Código fuente</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p style="text-align:justify;">Hasta ahora solo hemos trabajado con un usuario(el superusuario que creamos al principio) en nuestro proyecto, pero en la vida real son muchos los usuarios que interactuan con el software y todos no cuentan con los mismos permisos, hay algunos que pueden crear, ver, editar o eliminar elementos y otros no. Para empezar a trabajar con permisos primero debemos crear algunos usuarios adicionales, para ello vamos a ingresar a la consola de administración de Django, poniendo lo siguiente en nuestra barra de direcciones:</p>
<p>http://localhost:8000/admin</p>
<p>A continuación veremos una pantalla como esta:</p>
<p><a href="../../../../../2016/04/login_administracion.jpg"><img class="aligncenter size-medium wp-image-223" src="https://pythonpiura.files.wordpress.com/2016/04/login_administracion.jpg?w=300" alt="login_administracion" width="300" height="127"></a></p>
<p style="text-align:justify;">Aquí nos logueamos usando el superusuario con el que hemos venido trabajando y tendremos una pantalla como esta:</p>
<p><a href="../../../../../2016/04/admin_django.jpg"><img class="aligncenter size-medium wp-image-224" src="https://pythonpiura.files.wordpress.com/2016/04/admin_django.jpg?w=300" alt="admin_django" width="300" height="61"></a></p>
<p style="text-align:justify;">En el enlace donde dice Users vamos a dar click en Add para crear nuestro nuevo usuario, al que llamaremos usuario1:<br><a href="../../../../../2016/04/crear_usuario.jpg"><img class="aligncenter size-medium wp-image-225" src="https://pythonpiura.files.wordpress.com/2016/04/crear_usuario.jpg?w=300" alt="crear_usuario" width="300" height="88"></a><br>
Completamos los campos y le damos click a save:</p>
<p><a href="../../../../../2016/04/usuario_creado.jpg"><img class="aligncenter size-medium wp-image-226" src="https://pythonpiura.files.wordpress.com/2016/04/usuario_creado.jpg?w=300" alt="usuario_creado" width="300" height="207"></a></p>
<p style="text-align:justify;">Por ahora con esto es suficiente y ya tenemos nuestro usuario creado y listo para usarlo, salimos dando click en logout y nos vamos al login del proyecto para ingresar con nuestro nuevo usuario y la contraseña que le hemos asignado:<br><a href="../../../../../2016/04/nuevo_logueo.jpg"><img class="aligncenter size-medium wp-image-227" src="https://pythonpiura.files.wordpress.com/2016/04/nuevo_logueo.jpg?w=300" alt="nuevo_logueo" width="300" height="210"></a><br>
En nuestra aplicación personas, con este usuario podemos hacer lo mismo que con el usuario anterior, pero que pasa si nosotros queremos restringir algunas cosas a este nuevo usuario, por ejemplo, no dejar que este usuario cree ni modifique personas, pero que si pueda ver su detalle y exportar el reporte en una hoja de calculo ¿Cómo hacemos esto?<br>
Con Django otra vez esto es muy sencillo y podemos definir diferentes niveles de acceso, restringiendo las opciones en la plantilla html y negando el acceso a la vista en cuestión, hagamos lo primero:</p>
<p style="text-align:justify;">Si queremos restringir el acceso a las opciones desde la plantilla html, lo mas rápido que se nos ocurre es eliminar los íconos que nos brindan esas opciones, esto lo podemos hacer usando los permisos proporcionados por django de la siguiente manera:<br>
Primero para restringir la visualización del ícono de crear personas:<br>
personas.html</p>
<p>[sourcecode language="html"]<br>
{% if perms.personas.add_persona %}</p>
<p>&lt;div class="col-lg-1"&gt;<br>
	&lt;a id="crear_detalle" href="reporte_personas_excel’ %}" class="btn btn-info btn-block"&gt;<br>
		&lt;span class="glyphicon glyphicon-list-alt"&gt;&lt;/span&gt;<br>
	&lt;/a&gt;<br>
&lt;/div&gt;</p>
<p>{% endif %}<br>
[/sourcecode]</p>
<p style="text-align:justify;">Si observamos detenidamente hemos agregado en la parte superior del div del enlace un condicional que utilizar una variable llamada perms, en esta variable se almacenan los permisos de los que dispone el usuario que ha iniciado sesión, luego de perms podemos observar el nombre de la aplicación, en nuestro caso personas, y finalmente tenemos el permiso llamado add y el modelo persona que configuran el permiso add_persona, esta condificional nos dice, si el usuario tiene el permiso add_persona, entonces se debe renderizar el div, sino no hace nada.<br>
Si ejecutamos nuestra aplicación observamos lo siguiente:</p>
<p><a href="../../../../../2016/04/no_crear1.jpg"><img class="aligncenter size-medium wp-image-232" src="https://pythonpiura.files.wordpress.com/2016/04/no_crear1.jpg?w=300" alt="no_crear" width="300" height="119"></a></p>
<p style="text-align:justify;">El ícono de agregar ya no aparece, pero todavía no podemos cantar victoria, un usuario avispado puede recordar la url de creación de personas y tipearla directamente en la barra de direcciones:</p>
<p><a href="../../../../../2016/04/crear_persona.jpg"><img class="aligncenter size-medium wp-image-229" src="https://pythonpiura.files.wordpress.com/2016/04/crear_persona.jpg?w=300" alt="crear_persona" width="300" height="229"></a></p>
<p style="text-align:justify;">Mmmm, vemos que si puede ingresar ¿Cómo hacemos para restringir eso? Nuestros viejos amigos los decoradores vuelven nuevamente a nuestro auxilio, para ello debemos editar el archivo views.py:</p>
<p>[sourcecode language="python"]<br>
from django.contrib.auth.decorators import permission_required<br>
from django.utils.decorators import method_decorator<br>
class CrearPersona(CreateView):<br>
    model = Persona<br>
    fields =['dni','nombre','apellido_paterno','apellido_materno']<br>
    template_name = ‘crear_persona.html’<br>
    success_url = reverse_lazy(‘personas:personas’)</p>
<p>    @method_decorator(permission_required(‘personas.add_persona’,reverse_lazy(‘personas:personas’)))<br>
    def dispatch(self, *args, **kwargs):<br>
        return super(CrearPersona, self).dispatch(*args, **kwargs)<br>
[/sourcecode]</p>
<p style="text-align:justify;">Expliquemos esto que está un poco endiablado:<br>
Un método sobre una clase no equivale realmente a una función independiente, por lo que se debe transformar en un decorador primero, el decorador @method_decorator transforma un decorador de una función en un decorador de un método a fin de que puede ser usado sobre una instancia de un método, en el caso de las vistas basadas en clase a quien debemos aplicar el decorador es al método dispatch, en este ejemplo, cada instancia de CrearPersona tendrá protección de permission_required.<br>
El punto de entrada as_view() crea una instancia de la clase y llama al método dispatch(), (el despachador o resolvedor de URL) que busca la petición para determinar si es un GET, POST, etc, y releva la petición a un método que coincida con uno definido, o levante una excepción HttpResponseNotAllowed si no encuentra coincidencias.<br>
A la función permission_required se le deben pasar dos argumentos:<br>
El primero es el permiso a verificar que en este caso es add_persona y tiene la misma notación, primero la aplicación y luego el permiso.<br>
El segundo es la url a donde debe ser direccionado el usuario en caso de no tener el permiso necesario, en este caso a la url personas.</p>
<p style="text-align:justify;">Ahora pongamos nuevamente la url anterior y veamos que nos sale:</p>
<p><a href="../../../../../2016/04/permiso_denegado.jpg"><img class="aligncenter size-medium wp-image-230" src="https://pythonpiura.files.wordpress.com/2016/04/permiso_denegado.jpg?w=300" alt="permiso_denegado" width="300" height="142"></a></p>
<p style="text-align:justify;">Bueno con esto ya nos aseguramos que el usuario “usuario1″ no va a poder entrar de ninguna manera a la funcionalidad de creación de personas, ahora lo que falta es aplicar lo mismo a la vista ModificarPersona las demás vistas tendrá un tratamiento especial en un artículo posterior:</p>
<p>personas.html</p>
<p>[sourcecode language="html"]</p>
<p>&lt;tbody&gt;<br>
{% for persona in personas %}<br>
	&lt;tr&gt;<br>
		&lt;td&gt;{{ persona.dni }}&lt;/td&gt;<br>
		&lt;td&gt;{{ persona.nombre }}&lt;/td&gt;<br>
		&lt;td&gt;{{ persona.apellido_paterno }}&lt;/td&gt;<br>
		&lt;td&gt;{{ persona.apellido_materno }}&lt;/td&gt;<br>
		&lt;td class="text-center"&gt;<br>
			&lt;a class="btn btn-small" href="{% url ‘personas:detalle_persona’ persona.pk %}"&gt;<br>
				&lt;span class="glyphicon glyphicon-folder-open"&gt;&lt;/span&gt;<br>
			&lt;/a&gt;<br>
			{% if perms.personas.change_persona %}<br>
			&lt;a class="btn btn-small" href="{% url ‘personas:modificar_persona’ persona.pk %}"&gt;<br>
				&lt;span class="glyphicon glyphicon-pencil"&gt;&lt;/span&gt;<br>
			&lt;/a&gt;<br>
			{% endif %}<br>
		&lt;/td&gt;<br>
	&lt;/tr&gt;<br>
{% endfor %}<br>
&lt;/tbody&gt;</p>
<p>[/sourcecode]</p>
<p>views.py</p>
<p>[sourcecode language="python"]<br>
class ModificarPersona(UpdateView):<br>
    model = Persona<br>
    template_name = ‘modificar_persona.html’<br>
    fields = ['dni','nombre','apellido_paterno','apellido_materno']<br>
    success_url = reverse_lazy(‘personas:personas’)</p>
<p>    @method_decorator(permission_required(‘personas.change_persona’,reverse_lazy(‘personas:personas’)))<br>
    def dispatch(self, *args, **kwargs):<br>
        return super(ModificarPersona, self).dispatch(*args, **kwargs)<br>
[/sourcecode]</p>
<p style="text-align:justify;">Notamos que el permiso ahora se llama change_persona, detengamonos un poco aquí y expliquemos esto, por defecto django aplica tres permisos a cada uno de nuestros modelos: add, change y delete, que especifican si un usuario puede crear, modificar o borrar un elemento de un modelo dado, en este caso el modelo es persona.</p>
<p style="text-align:justify;">Si corremos nuestra proyecto tenemos lo siguiente:</p>
<p><a href="../../../../../2016/04/sin_accesos.jpg"><img class="aligncenter size-medium wp-image-233" src="https://pythonpiura.files.wordpress.com/2016/04/sin_accesos.jpg?w=300" alt="sin_accesos" width="300" height="113"></a></p>
<p style="text-align:justify;">Nótese que ya no aparece el lápiz de edición y tampoco se puede acceder con el url de modificar directamente en la barra de direcciones.</p>
<p style="text-align:justify;">Ahora vamos a crear un nuevo usuario llamado usuario2, al que si le vamos a dar los permisos de crear y modificar, repetimos los pasos para crear el usuario en la interfaz de administración y nos detenemos en la ventana posterior a la creación del usuario, en la opción de permisos:</p>
<p><a href="../../../../../2016/04/permisos.jpg"><img class="aligncenter size-medium wp-image-234" src="https://pythonpiura.files.wordpress.com/2016/04/permisos.jpg?w=300" alt="permisos" width="300" height="86"></a></p>
<p style="text-align:justify;">En esta opción tenemos un sinnumero de permisos, busquemos los relacionados a la aplicación personas y al modelo persona y los seleccionamos:</p>
<p><a href="../../../../../2016/04/seleccionar_permisos.jpg"><img class="aligncenter size-medium wp-image-235" src="https://pythonpiura.files.wordpress.com/2016/04/seleccionar_permisos.jpg?w=300" alt="seleccionar_permisos" width="300" height="89"></a></p>
<p>Seleccionamos la flechita entre los dos cuadros y le damos al botón Save:</p>
<p><a href="../../../../../2016/04/escoger.jpg"><img class="aligncenter size-medium wp-image-236" src="https://pythonpiura.files.wordpress.com/2016/04/escoger.jpg?w=300" alt="escoger" width="300" height="78"></a></p>
<p style="text-align:justify;">Con esto ya tenemos que el usuario “usuario2″ tiene los permisos asignados. Ahora salgamos de la interfaz de administración e ingresemos a nuestro proyecto con el “usuario2″:</p>
<p><a href="../../../../../2016/04/con_permisos.jpg"><img class="aligncenter size-medium wp-image-237" src="https://pythonpiura.files.wordpress.com/2016/04/con_permisos.jpg?w=300" alt="con_permisos" width="300" height="115"></a></p>
<p style="text-align:justify;">Listo ahora si el usuario2, ya tendrá estos permisos básicos y el usuario1 no, el usuario mamaya es superusuario por lo tanto puede ingresar donde quiera.</p>
<p style="text-align:justify;">Eso es todo.<br>
Saludos.</p>

    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../../categories/django/" rel="tag">Django</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../mejorando-nuestro-login/" rel="prev" title="Mejorando Nuestro Login">Publicación anterior</a>
            </li>
            <li class="next">
                <a href="../../../05/02/personalizando-permisos/" rel="next" title="Personalizando Permisos">Siguiente publicación</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:pythonpiura@openmailbox.org">Comunidad Python Piura</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
            
        </footer>
</div>
</div>


            <script src="../../../../../assets/js/all-nocdn.js"></script><script src="../../../../../assets/js/colorbox-i18n/jquery.colorbox-es.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("es");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76551557-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
