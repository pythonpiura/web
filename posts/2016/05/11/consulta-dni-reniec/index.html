<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://pythonpiura.org/posts/2016/05/11/consulta-dni-reniec/">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Consulta DNI - RENIEC | Python Piura</title>
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../../rss.xml">
<link rel="canonical" href="http://pythonpiura.org/posts/2016/05/11/consulta-dni-reniec/">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Miguel Amaya">
<link rel="prev" href="../../10/otro-ejemplo-de-web-scrapping-con-python/" title="Otro Ejemplo de Web Scrapping con Python" type="text/html">
<link rel="next" href="../../13/reporte-pdf-en-django-con-reportlab/" title="Reporte PDF en Django con Reportlab" type="text/html">
<meta property="og:site_name" content="Python Piura">
<meta property="og:title" content="Consulta DNI - RENIEC">
<meta property="og:url" content="http://pythonpiura.org/posts/2016/05/11/consulta-dni-reniec/">
<meta property="og:description" content="En esta oportunidad vamos a hacer un ejemplo mas complejo, ya que el captcha así lo amerita, nuestra página objetivo es la siguiente:
https://cel.reniec.gob.pe/valreg/valreg.do

En esta página podemos">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-05-11T21:37:08-05:00">
<meta property="article:tag" content="pillow">
<meta property="article:tag" content="pytesseract">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Selenium">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://pythonpiura.org/">

                <span id="blog-title">Python Piura</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../../../../blog">Blog</a>
                </li>
<li>
<a href="../../../../../eventos.html">Eventos</a>
                </li>
<li>
<a href="../../../../../material-python.html">Material</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.src.html" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Consulta DNI - RENIEC</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Miguel Amaya
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-05-11T21:37:08-05:00" itemprop="datePublished" title="2016-05-11 21:37">2016-05-11 21:37</time></a></p>
            
        <p class="sourceline"><a href="index.src.html" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p style="text-align:justify;">En esta oportunidad vamos a hacer un ejemplo mas complejo, ya que el captcha así lo amerita, nuestra página objetivo es la siguiente:<br><a href="https://cel.reniec.gob.pe/valreg/valreg.do">https://cel.reniec.gob.pe/valreg/valreg.do</a><br><a href="../../../../../2016/05/reniec.jpg"><img class="aligncenter size-full wp-image-274" src="../../../../../2016/05/reniec.jpg" alt="reniec" width="579" height="396"></a><br>
En esta página podemos ingresar el número de DNI y obtener el nombre completo del ciudadano. Como se ve en la imagen aquí nos enfrentamos a un captcha mas completo y a un teclado dinámico compuesto de botones, para romper este captcha tenemos que modificar la imagen para obtener el texto correcto, eliminando las lineas que atraviesan las letras y que tienen una tonalidad distinta de azul, el proceso no será 100% seguro pero funciona en la mayoría de los casos:</p>
<p>[sourcecode language="python"]<br>
# -*- coding: utf-8 -*-<br>
from selenium import webdriver<br>
from selenium.webdriver.common.by import By<br>
from selenium.webdriver.support.wait import WebDriverWait<br>
from selenium.webdriver.support import expected_conditions as EC</p>
<p>try:<br>
    import Image<br>
except ImportError:<br>
    from PIL import Image<br>
import pytesseract</p>
<p>def ir_reniec_web(dni):<br>
    fp = webdriver.FirefoxProfile()<br>
    driver = webdriver.Firefox(fp)<br>
    #Definimos nuestra página objetivo<br>
    driver.get("https://cel.reniec.gob.pe/valreg/valreg.do")<br>
    try:<br>
        #Esperamos hasta que se cargue la imagen con el captcha<br>
        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.ID, "imagcodigo")))<br>
    except:<br>
        print "Element is not present"<br>
    #Hacemos la captura de pantalla correspondiente<br>
    driver.save_screenshot("screenshot.png")<br>
    img=Image.open(‘screenshot.png’)<br>
    #Obtenemos el ancho y el largo de la imagen<br>
    ancho = img.size[0]<br>
    alto = img.size[1]<br>
    #Recortamos la parte del captcha teniendo en cuenta el ancho y el largo de la imagen<br>
    img_recortada = img.crop((int(ancho/4.26),int(alto/3.64),int(ancho/2.8),int(alto/3)))<br>
    #Guardamos el recorte<br>
    img_recortada.save("recorte.png")<br>
    #Recorremos cada uno de los dígitos del DNI<br>
    for num in dni:<br>
        #Buscamos el boton que tenga como nombre tecla_0<br>
        boton_0 = driver.find_element_by_name("tecla_0")<br>
        #Obtenemos el valor del botón con nombre tecla_0<br>
        valor_0 = boton_0.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_1<br>
        boton_1 = driver.find_element_by_name("tecla_1")<br>
        #Obtenemos el valor del botón con nombre tecla_1<br>
        valor_1 = boton_1.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_2<br>
        boton_2 = driver.find_element_by_name("tecla_2")<br>
        #Obtenemos el valor del botón con nombre tecla_2<br>
        valor_2 = boton_2.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_3<br>
        boton_3 = driver.find_element_by_name("tecla_3")<br>
        #Obtenemos el valor del botón con nombre tecla_3<br>
        valor_3 = boton_3.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_4<br>
        boton_4 = driver.find_element_by_name("tecla_4")<br>
        #Obtenemos el valor del botón con nombre tecla_4<br>
        valor_4 = boton_4.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_5<br>
        boton_5 = driver.find_element_by_name("tecla_5")<br>
        #Obtenemos el valor del botón con nombre tecla_5<br>
        valor_5 = boton_5.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_6<br>
        boton_6 = driver.find_element_by_name("tecla_6")<br>
        #Obtenemos el valor del botón con nombre tecla_6<br>
        valor_6 = boton_6.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_7<br>
        boton_7 = driver.find_element_by_name("tecla_7")<br>
        #Obtenemos el valor del botón con nombre tecla_7<br>
        valor_7 = boton_7.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_8<br>
        boton_8 = driver.find_element_by_name("tecla_8")<br>
        #Obtenemos el valor del botón con nombre tecla_8<br>
        valor_8 = boton_8.get_attribute(‘value’)<br>
        #Buscamos el boton que tenga como nombre tecla_9<br>
        boton_9 = driver.find_element_by_name("tecla_9")<br>
        #Obtenemos el valor del botón con nombre tecla_9<br>
        valor_9 = boton_9.get_attribute(‘value’)<br>
        ”’Consultamos si el dígito del DNI es igual al valor del botón,<br>
        si es el caso entonces se da click en ese botón”’<br>
        if num==valor_0:<br>
            boton_0.click()<br>
        elif num==valor_1:<br>
            boton_1 = driver.find_element_by_name("tecla_1")<br>
            boton_1.click()<br>
        elif num==valor_2:<br>
            boton_2 = driver.find_element_by_name("tecla_2")<br>
            boton_2.click()<br>
        elif num==valor_3:<br>
            boton_3 = driver.find_element_by_name("tecla_3")<br>
            boton_3.click()<br>
        elif num==valor_4:<br>
            boton_4 = driver.find_element_by_name("tecla_4")<br>
            boton_4.click()<br>
        elif num==valor_5:<br>
            boton_5 = driver.find_element_by_name("tecla_5")<br>
            boton_5.click()<br>
        elif num==valor_6:<br>
            boton_6 = driver.find_element_by_name("tecla_6")<br>
            boton_6.click()<br>
        elif num==valor_7:<br>
            boton_7 = driver.find_element_by_name("tecla_7")<br>
            boton_7.click()<br>
        elif num==valor_8:<br>
            boton_8 = driver.find_element_by_name("tecla_8")<br>
            boton_8.click()<br>
        elif num==valor_9:<br>
            boton_9 = driver.find_element_by_name("tecla_9")<br>
            boton_9.click()<br>
    #Se llama al método romper_captcha para obtener el texto correspondiente<br>
    captcha = romper_captcha("recorte.png")<br>
    try:<br>
        #Obtenemos la caja de texto donde se escribe el texto del captcha<br>
        codigo = driver.find_element_by_name("imagen")<br>
        #Si el captcha está vacio o no se ha logrado romper se cierra el navegador y se termina la aplicación<br>
        if captcha==”:<br>
            driver.close()<br>
            return<br>
        #Escribimos el texto<br>
        codigo.send_keys(captcha)<br>
    except:<br>
        pass<br>
    try:<br>
        #Obtenemos el botón de consulta<br>
        boton_consultar=driver.find_element_by_name("bot_consultar")<br>
        #Damos click al botón de consulta<br>
        boton_consultar.click()<br>
    except:<br>
        print "Element is not present"<br>
    #Obtengo el resultado que aparece en el elemento llamado style2<br>
    resultado = driver.find_element_by_class_name("style2")<br>
    #Partimos el resultado para obtener el nombre<br>
    nombre = resultado.text.split(‘\n’)<br>
    driver.close()<br>
    return nombre[0]</p>
<p>def romper_captcha(nombre_imagen):<br>
    #Abro la imagen<br>
    img = Image.open(nombre_imagen)<br>
    #Obtengo un arreglo de píxeles de la imagen<br>
    pixdata = img.load()<br>
    ”’Modifico los píxeles de la imagen de acuerdo al análisis de los colores de las letras<br>
    y las lineas que cruzan el texto, pintando de negro los píxeles del texto y de blanco las lineas”’<br>
    for y in xrange(img.size[1]):<br>
        for x in xrange(img.size[0]):<br>
            if pixdata[x, y][2] &lt; 146: pixdata[x, y] = (255, 255, 255) for y in xrange(img.size[1]): for x in xrange(img.size[0]): if pixdata[x, y][1] &gt; 64:<br>
                pixdata[x, y] = (255, 255, 255)<br>
            else:<br>
                pixdata[x, y] = (0,0,0)<br>
    #Guardo la imagen modificada<br>
    img.save("modificado.jpg")<br>
    #Abro la imagen modificado<br>
    image = Image.open("modificado.jpg")<br>
    #Obtenemos el texto de la imagen<br>
    frase = pytesseract.image_to_string(image)<br>
    #Retornamos el texto eliminado los espacios en blanco entre las palabras y convirtiendolas en mayúsculas<br>
    return frase.replace(‘ ‘,”).upper()</p>
<p>def main():<br>
    dni = ’123456789′<br>
    print ir_reniec_web(dni)</p>
<p>main()<br>
[/sourcecode]</p>
<p>Espero que les sea útil.<br>
Saludos.</p>

    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../../categories/pillow/" rel="tag">pillow</a></li>
            <li><a class="tag p-category" href="../../../../../categories/pytesseract/" rel="tag">pytesseract</a></li>
            <li><a class="tag p-category" href="../../../../../categories/python/" rel="tag">Python</a></li>
            <li><a class="tag p-category" href="../../../../../categories/selenium/" rel="tag">Selenium</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../10/otro-ejemplo-de-web-scrapping-con-python/" rel="prev" title="Otro Ejemplo de Web Scrapping con Python">Previous post</a>
            </li>
            <li class="next">
                <a href="../../13/reporte-pdf-en-django-con-reportlab/" rel="next" title="Reporte PDF en Django con Reportlab">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:ythonpiura@openmailbox.org">Miguel Amaya</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../../../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
