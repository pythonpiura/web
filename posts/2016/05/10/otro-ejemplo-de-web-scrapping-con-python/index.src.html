<html><body><p style="text-align:justify;">En esta oportunidad vamos a compartir con ustedes un nuevo script para consultar rucs de manera masiva a partir del DNI en la página web de sunat, esto ha sido un poco mas complejo debido a que la página en cuestión usa frames, también hemos mejorado un poquito el problema de los tamaños haciendo el recorte a partir del tamaño de la captura de pantalla:</p>
<p>[sourcecode language="python"]<br>
# -*- coding: utf-8 -*-<br>
from selenium import webdriver<br>
from selenium.webdriver.common.by import By<br>
from selenium.webdriver.support.wait import WebDriverWait<br>
from selenium.webdriver.support import expected_conditions as EC<br>
try:<br>
    import Image<br>
except ImportError:<br>
    from PIL import Image<br>
import pytesseract</p>
<p>def ir_sunat_web(dni):<br>
    driver = webdriver.Firefox()<br>
    #Fijamos nuestra página objetivo<br>
    driver.get("http://ww1.sunat.gob.pe/cl-ti-itmrconsruc/jcrS00Alias")<br>
    try:<br>
        #Debido a que la página tiene frames debemos hacer el cambio al frame con nombre "leftFrame"<br>
        driver.switch_to_frame("leftFrame")<br>
    except:<br>
        return []<br>
        driver.close()<br>
    try:<br>
        #Obtenemos los radio buttons que nos permiten seleccionar el tipo de búsqueda a hacer<br>
        radios = driver.find_elements_by_name("tQuery")<br>
        #Seleccionamos la búsqueda por DNI<br>
        radios[1].click()<br>
        #Obtenemos la caja de texto donde se ingresa el DNI<br>
        documento = driver.find_element_by_name("search2")<br>
        #Escribimos el DNI<br>
        documento.send_keys(dni)<br>
        #Esperamos hasta que el texto esté escrito en la caja de texto del DNI<br>
        WebDriverWait(driver, 5).until(EC.text_to_be_present_in_element_value((By.NAME, "search2"),dni))<br>
    except:<br>
        driver.close()<br>
        return []<br>
    try:<br>
        #Esperamos hasta que se cargue la imagen con el captcha<br>
        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.NAME, "imagen")))<br>
        #Hacemos la captura de pantalla correspondiente<br>
        driver.save_screenshot("screenshot.jpg")<br>
        img=Image.open(‘screenshot.jpg’)<br>
        #Obtenemos el ancho y el largo de la imagen<br>
        ancho = img.size[0]<br>
        alto = img.size[1]<br>
        #Recortamos la parte del captcha teniendo en cuenta el ancho y el largo de la imagen<br>
        img_recortada = img.crop((ancho/1.4,alto/20,ancho/1.25,alto/6.9))<br>
        #Guardamos el recorte<br>
        img_recortada.save("recorte.jpg")<br>
        #Obtenemos el texto del captcha<br>
        captcha = pytesseract.image_to_string(img_recortada)<br>
        #Obtenemos la caja de texto donde se escribe el texto del captcha<br>
        codigo = driver.find_element_by_name("codigo")<br>
        #Escribimos el texto<br>
        codigo.send_keys(captcha)<br>
    except:<br>
        driver.close()<br>
        return []<br>
    try:<br>
        #Obtenemos el botón de búsqueda<br>
        boton = driver.find_element_by_class_name("form-button")<br>
        #Damos click al botón de búsqueda<br>
        boton.click()<br>
        #Cambiamos al frame por defecto<br>
        driver.switch_to_default_content()<br>
        #Cambiamos al frame llamado "mainFrame" que contiene la tabla de resultados con un enlace conteniendo el ruc<br>
        driver.switch_to_frame("mainFrame")<br>
    except:<br>
        driver.close()<br>
        return []<br>
    try:<br>
        #Esperamos que se cargue la tabla de resultados<br>
        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.CLASS_NAME, "form-table")))<br>
        #Obtenemos el enlace que contiene al RUC<br>
        enlace=driver.find_element(By.TAG_NAME,"a")<br>
        #Le damos click al enlace<br>
        enlace.click()<br>
        #Ahora si tenemos una tabla que contiene el detalle de los resultados del RUC consultado<br>
        #Obtenemos todas las filas<br>
        trs = driver.find_elements(By.TAG_NAME, "tr")<br>
        #Obtenemos las celdas de la primera fila<br>
        tds = trs[0].find_elements(By.TAG_NAME, "td")<br>
        #A la segunda celda la partimos ya que tiene el ruc y la razón social separados por un guión<br>
        primera_linea = tds[1].text.split(‘-’)<br>
        ruc = primera_linea[0].strip()<br>
        razon_social = primera_linea[1].strip()<br>
        #Obtenemos la segunda linea que tiene el tipo de contribuyente<br>
        tds = trs[1].find_elements(By.TAG_NAME, "td")<br>
        tipo_contribuyente = tds[1].text.strip()<br>
        #Obtenemos la dirección<br>
        tds = trs[7].find_elements(By.TAG_NAME, "td")<br>
        direccion = tds[1].text.strip()<br>
    except:<br>
        driver.close()<br>
        return []<br>
    driver.close()<br>
    #Devolvemos una lista con los resultados.<br>
    datos = [ruc,razon_social,tipo_contribuyente,direccion]<br>
    return datos    </p>
<p>def main():<br>
    #Ingresar DNI<br>
    dni = ’12345678′<br>
    print ir_sunat_web(dni)</p>
<p>main()<br>
[/sourcecode]</p>
<p>http://www.youtube.com/watch?v=ijICFYtAuDE</p>
<p>Esperamos que les sea útil.<br>
Saludos.</p>
</body></html>